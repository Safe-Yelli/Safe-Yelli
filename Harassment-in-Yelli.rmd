---
title: "Mapping harassment in Yelahanka"
date: "19/10/2021"
output:
  html_document: 
    theme: cosmo
    toc: yes
    toc_float: yes
    toc_depth: 2
    code_folding: hide
    code_download: yes
knit: (function(input, ...) {
    rmarkdown::render(
      input,
      output_file = paste0(
      'index.html'
      ),
      envir = globalenv()
    )
  })
---
```{css, echo = F}
.title{
  font-size: 80px;
  background-color: #dbbcbce3;
  color: black;
 
  border: 1px;
  border-radius: 6px;
  padding-left 10px;
}

h1{
  background-color:#e7f1ebe3;
  color: black;
  border: 1px;
  border-radius: 6px;
  padding: 2px 0 2px 5px;
}

.tocify-item{
  background-color: #d1cfc034
}

.list-group-item.active{
  background-color: #e7f1ebe3;
  color: black
}

//[aria-expanded="true"]

a:focus{
 background-color: #e7f1ebe3;
  color: black
}


.map{
  height: 100vh;    
  width: 100%;
}
```
Abstract: To find spatial correlations between catcalling hot-spots and public-utility and attempt to affect public policy by running a pro-policing campaign with this tool

**This is currently only a working proof of concept. Not meant for public release yet.**



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(sf)
library(leaflet)
library(leaflet.providers)
library(leaflet.extras)
library(rgdal)
library(crosstalk)
```

```{r reading data, include=FALSE}
harassData <- read_csv('formResponses.csv')
harassData <- harassData %>% separate(., col = `What are the exact coordinates of the incident?`, into = c("lat", "lng"), sep = "\\,")
# Attach a coordinate reference 
harassCoords <- harassData %>%
  st_as_sf(coords = c('lng', 'lat'),crs = 4326) 
harassCoords
```

# Use the map here {.tabset}

```{r reading files and other stuff, include=FALSE}
mapUrl="https://api.mapbox.com/styles/v1/rungdung/cku6gh76r1dvh17o3zkfllvjz/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1IjoicnVuZ2R1bmciLCJhIjoiY2tqeWh6cXF4MDgzMjJvbWVmbGQzYjAwMyJ9.U-aJyoqyKvTXlhVk43jV1A"

# Read KML file's layers into separate objects
st_layers("hotspots.kml")
shopPlot = readOGR("hotspots.kml", layer="Shops")
emptyPlot = readOGR("hotspots.kml", layer="Empty plots")
infrasPlot = readOGR("hotspots.kml", layer="Dilipated public infrastructure")

# Convert year to field
#harassCoords <- harassCoords %>% mutate(`Year of Occurence`=as.Date(`Year of Occurence`))
shared_data <- SharedData$new(harassCoords)
filter_slider("date", "Date", shared_data, ~`Year of Occurence`) # not working yet 
# https://stackoverflow.com/questions/62849300/r-leaflet-add-a-range-slider-to-filter-markers-without-shiny

```

## Incidents
<iframe class ="map" src="https://safeyelli.ushahidi.io/views/map" frameborder="0" allowfullscreen data-external="1"></iframe>


## Heatmap
```{r Mappinnng!, echo=FALSE, out.width='100%'}
#addProviderTiles(providers$CartoDB.Positron) not working
map<-leaflet(shared_data) %>% 
  addTiles(urlTemplate = mapUrl) %>% 
  fitBounds(77.554808,13.087922,77.608495,13.114213) %>% 
  setMaxBounds(77.554808,13.087922,77.608495,13.114213) %>% 
  addCircleMarkers(#label = harassCoords$Misc,
                   opacity=0.09,
                   #fillColor = ~pal(`Year of Occurence`),
                   clusterOptions = markerClusterOptions(),
                   group = "Incident markers"
                   ) %>%


  # Layers
  addPolygons(data = emptyPlot,
              color = 'grey',
              stroke=FALSE,
              label = emptyPlot$Name,
              group="Empty Plots") %>% 
  addPolygons(data = infrasPlot,
              color = 'red',
              stroke=FALSE,
              label = infrasPlot$Name,
              group="Dilipated infrastructure") %>% 
  addPolygons(data = shopPlot,
              color = 'green',
              stroke=FALSE,
              label = shopPlot$Name,
              group="Shops") %>%
  
  
  addHeatmap(radius =18, 
             blur =15, 
             intensity = 0.7, 
             cellSize = 0.1, 
             minOpacity = 0.1,
             group = "Heat Map") %>% 
  
  # UI controls
  # addLegend(pal=pal,
  #          title="what is this",
  #          values= ~`Year of Occurence`) %>% 
  addScaleBar() %>% 
  addLayersControl(
    baseGroups = c("Heat Map","Incident markers"),
    overlayGroups = c("Empty Plots", "Dilipated infrastructure", "Shops"),
    options = layersControlOptions(collapsed = FALSE))

map
```



### Usage  {.tabset}

Use the selection tool on the right to shift between viewing a heat map and viewing precise incidents. Click on the circles while viewing precise incidents to read about it. 

### Viewing status of infrastructure

You can use the checkboxes to enable and disable seeing the status of infrastructure around Yelahanka. Ill lit streets and parks are some of the infrastructure that would be mapped (InProgress)



# Why are we doing this?

filler: Talk about the importance of reporting and data collection.  Importance of understanding the social engineering behind crime hotspots and getting the required data for that. 

Why is it important to report?

# Affecting policy

filler: Will be rewritten to talk about how people can use this tool to better inform their movements at given times and talk about possibly helping law enforcement(promise nothing)

# Telling your story

If you would to have your incident listed on this map, you can reach out to us to record your story. The map will be updated periodically.

<iframe width="100%" height="600" src="https://safeyelli.ushahidi.io/posts/create/1" frameborder="0" allowfullscreen data-external="1"></iframe>

# Creators, contributors
Adhavan Mohana Sivaraj,
Shashank C,
Shresth Meharia,
